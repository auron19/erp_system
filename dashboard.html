<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Pholai's Boutique</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- QR Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #764ba2;
            --accent: #4fd1c7;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --light: #f7fafc;
            --dark: #2d3748;
            --gray: #a0aec0;
            --gray-light: #e2e8f0;
            --border-radius: 8px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--light);
            color: var(--dark);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
        }
        
        /* ===== LAYOUT COMPONENTS ===== */
        .app-container {
            display: flex;
            width: 100%;
        }
        
        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            height: 100vh;
            position: fixed;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: var(--transition);
        }
        
        .logo {
            padding: 2rem 1.5rem;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .logo-main {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .logo-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            font-style: italic;
        }
        
        .nav-links { 
            padding: 1rem 0; 
            flex-grow: 1;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: white;
            text-decoration: none;
            transition: var(--transition);
            border-left: 4px solid transparent;
        }
        
        .nav-link:hover {
            background: rgba(255,255,255,0.1);
            border-left: 4px solid #fff;
        }
        
        .nav-link.active {
            background: rgba(255,255,255,0.2);
            border-left: 4px solid #fff;
        }
        
        .nav-link i { 
            width: 20px; 
            margin-right: 1rem;
            font-size: 1.1rem;
        }
        
        /* ===== MAIN CONTENT ===== */
        .main-content {
            margin-left: 280px;
            padding: 2rem;
            width: calc(100% - 280px);
            min-height: 100vh;
            transition: var(--transition);
        }
        
        .header {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: var(--dark);
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        /* ===== CARDS ===== */
        .card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-title i {
            color: var(--primary);
        }
        
        /* ===== STATS GRID ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            transition: var(--transition);
            border-top: 4px solid var(--primary);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .stat-card i {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }
        
        .stat-card h3 {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-card p {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--dark);
        }
        
        /* ===== SECTIONS ===== */
        .section { 
            display: none; 
        }
        
        .section.active { 
            display: block; 
        }
        
        /* ===== BUTTONS ===== */
        .btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.875rem;
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), #38a169);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #e53e3e);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #dd6b20);
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--accent), #319795);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        /* ===== GRID LAYOUTS ===== */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .grid-2-1 {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }
        
        /* ===== POS STYLES ===== */
        .pos-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-light);
            transition: var(--transition);
        }
        
        .cart-item:hover {
            background: var(--light);
        }
        
        /* ===== INVENTORY STYLES ===== */
        .inventory-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        /* ===== FORM STYLES ===== */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }
        
        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* ===== TAB STYLES ===== */
        .tab-buttons {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--gray-light);
        }
        
        .tab-button {
            padding: 1rem 2rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }
        
        .tab-button:hover {
            color: var(--primary);
        }
        
        .tab-button.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ===== TABLE STYLES ===== */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .table th, .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .table th {
            background: var(--light);
            font-weight: 600;
            color: var(--dark);
        }
        
        .table tr:hover {
            background: var(--light);
        }
        
        /* ===== STATUS INDICATORS ===== */
        .stock-low {
            color: var(--warning);
            font-weight: bold;
        }
        
        .stock-ok {
            color: var(--success);
            font-weight: bold;
        }
        
        .out-of-stock {
            color: var(--danger);
            font-weight: bold;
            background: #fed7d7;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        /* ===== MODAL STYLES ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        /* ===== LOADING INDICATOR ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ===== NOTIFICATION STYLES ===== */
        .floating-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
        }
        
        .floating-notification.error {
            background: var(--danger);
        }
        
        .floating-notification.warning {
            background: var(--warning);
            color: #000;
        }
        
        .floating-notification.info {
            background: var(--accent);
        }
        
        .notification-close {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 1.2rem;
            margin-left: auto;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* ===== SECURITY BADGE ===== */
        .security-badge {
            background: var(--success);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 10px;
        }
        
        /* ===== REAL-TIME INDICATOR ===== */
        .real-time-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* ===== CATEGORY TABS ===== */
        .category-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .category-tabs .tab-button {
            padding: 0.5rem 1rem;
            background: var(--light);
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .category-tabs .tab-button.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .category-tabs .tab-button:hover {
            background: var(--gray-light);
        }
        
        .category-tabs .tab-button.active:hover {
            background: var(--primary-dark);
        }
        
        /* ===== CHART CONTAINERS ===== */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* ===== QR CODE STYLES ===== */
        .qr-container {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            border: 2px dashed var(--primary);
        }
        
        /* ===== RESPONSIVE STYLES ===== */
        @media (max-width: 1024px) {
            .grid-2, .grid-2-1, .pos-grid, .inventory-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            
            .tab-buttons {
                flex-direction: column;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .user-info {
                width: 100%;
                justify-content: space-between;
            }
        }
        
        /* ===== PRINT STYLES ===== */
        @media print {
            body * {
                visibility: hidden;
            }
            #receiptModal, #receiptModal * {
                visibility: visible;
            }
            #receiptModal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }

        /* QR Scanner Specific Styles */
        #qr-reader {
            border: 2px solid var(--primary) !important;
            border-radius: var(--border-radius);
            margin: 0 auto;
        }

        #qr-reader__dashboard_section {
            background: var(--light);
            padding: 1rem;
            border-radius: var(--border-radius);
        }

        .scanner-controls {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    ">
        <div style="text-align: center;">
            <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">TRIPLE A</h1>
            <p style="font-size: 1.2rem; margin-bottom: 2rem;">Pholai's Boutique</p>
            <div class="loading" style="width: 50px; height: 50px;"></div>
            <p id="loadingText" style="margin-top: 1rem;">Initializing Secure Dashboard...</p>
            <p style="font-size: 0.8rem; margin-top: 1rem; opacity: 0.8;">
                <i class="fas fa-shield-alt"></i> Security Features Enabled
            </p>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <div class="logo-main">TRIPLE A</div>
                <div class="logo-subtitle">Pholai's Boutique</div>
            </div>
            <div class="nav-links">
                <a href="#" class="nav-link active" onclick="showSection('dashboard')">
                    <i class="fas fa-chart-bar"></i> Dashboard
                </a>
                <a href="#" class="nav-link" onclick="showSection('pos')">
                    <i class="fas fa-cash-register"></i> POS System
                </a>
                <a href="#" class="nav-link" onclick="showSection('inventory')">
                    <i class="fas fa-tshirt"></i> Inventory
                </a>
                <a href="#" class="nav-link" onclick="showSection('reports')">
                    <i class="fas fa-chart-line"></i> Reports
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1 id="page-title">
                    <span class="real-time-indicator"></span>
                    Dashboard Overview
                    <span class="security-badge" id="securityStatus">
                        <i class="fas fa-shield-alt"></i> Secure
                    </span>
                </h1>
                <div class="user-info">
                    <div>
                        <strong id="username-display">Administrator</strong><br>
                        <small>Pholai's Boutique</small>
                        <small style="display: block; color: var(--primary);" id="userRole"></small>
                    </div>
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>TODAY'S SALES</h3>
                        <p id="today-sales">â‚±0.00</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-tshirt"></i>
                        <h3>TOTAL PRODUCTS</h3>
                        <p id="total-products">0</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>LOW STOCK ITEMS</h3>
                        <p id="low-stock">0</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-calendar-day"></i>
                        <h3>TODAY'S TRANSACTIONS</h3>
                        <p id="today-transactions">0</p>
                    </div>
                </div>

                <div class="grid-2-1" style="margin-bottom: 2rem;">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-chart-line"></i> Sales Performance (Last 7 Days)</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-boxes"></i> Inventory Status</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="inventoryChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-fire"></i> Top Selling Products</h3>
                        </div>
                        <div id="top-products" style="margin-top: 1rem;">
                            <div class="cart-item">
                                <div>
                                    <strong>No data yet</strong><br>
                                    <small>Start selling to see top products</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i class="fas fa-bell"></i> Recent Activity</h3>
                        </div>
                        <div id="recent-activity" style="margin-top: 1rem;">
                            <div class="cart-item">
                                <i class="fas fa-info-circle" style="color: var(--primary);"></i>
                                <div style="flex: 1; margin-left: 1rem;">
                                    <strong>System Started</strong><br>
                                    <small>Welcome to Pholai's Boutique</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- POS Section -->
            <div id="pos" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-cash-register"></i> Point of Sale System</h2>
                    </div>
                    
                    <div class="pos-grid">
                        <!-- Left: Product Input & Cart -->
                        <div>
                            <div style="margin-bottom: 1.5rem;">
                                <input type="text" id="barcodeInput" class="form-control" 
                                       placeholder="ðŸ“¦ Scan QR/Barcode or enter product code">
                                <div id="product-search-results" style="display: none; margin-top: 0.5rem; border: 1px solid var(--gray-light); border-radius: var(--border-radius); max-height: 200px; overflow-y: auto;"></div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title"><i class="fas fa-shopping-cart"></i> Shopping Cart</h4>
                                </div>
                                <div id="cart" style="min-height: 400px; max-height: 500px; overflow-y: auto; margin-top: 1rem;">
                                    <p style="text-align: center; color: var(--gray); padding: 3rem;">Cart is empty<br><small>Scan products to add them to cart</small></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right: Payment Section -->
                        <div>
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title"><i class="fas fa-receipt"></i> Payment Summary</h4>
                                </div>
                                <div style="margin: 1.5rem 0;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                        <span>Subtotal:</span>
                                        <span id="subtotal">â‚±0.00</span>
                                    </div>
                                    <hr style="margin: 1rem 0;">
                                    <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold;">
                                        <span>Total:</span>
                                        <span id="total">â‚±0.00</span>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="payment-method">Payment Method</label>
                                    <select id="payment-method" class="form-control">
                                        <option value="cash">Cash</option>
                                        <option value="gcash">GCash</option>
                                        <option value="card">Credit/Debit Card</option>
                                    </select>
                                </div>
                                
                                <button onclick="processPayment()" class="btn" style="width: 100%; padding: 15px; margin-bottom: 1rem;">
                                    <i class="fas fa-credit-card"></i> Process Payment
                                </button>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title"><i class="fas fa-qrcode"></i> Scanner</h4>
                                </div>
                                <button onclick="openQRScanner()" class="btn btn-info" style="width: 100%; margin: 0.5rem 0;">
                                    <i class="fas fa-camera"></i> Scan QR Code
                                </button>
                                <button onclick="clearCart()" class="btn btn-danger" style="width: 100%; margin: 0.5rem 0;">
                                    <i class="fas fa-trash"></i> Clear Cart
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory Section -->
            <div id="inventory" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-tshirt"></i> Inventory Management</h2>
                    </div>
                    
                    <div class="tab-buttons">
                        <button class="tab-button active" onclick="showTab('products-tab')">Products List</button>
                        <button class="tab-button" onclick="showTab('add-product-tab')">Add Product</button>
                        <button class="tab-button" onclick="showTab('qr-generator-tab')">QR Code Generator</button>
                    </div>
                    
                    <!-- Products List Tab -->
                    <div id="products-tab" class="tab-content active">
                        <div class="card-header">
                            <h3>Product Inventory</h3>
                            <button class="btn btn-success" onclick="loadProducts()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                        <div id="products-list">
                            <div class="loading"></div> Loading products...
                        </div>
                    </div>
                    
                    <!-- Add Product Tab -->
                    <div id="add-product-tab" class="tab-content">
                        <div class="card-header">
                            <h3>Add New Product</h3>
                        </div>
                        <form id="add-product-form">
                            <div class="grid-2">
                                <div class="form-group">
                                    <label for="productBarcode">Barcode *</label>
                                    <input type="text" id="productBarcode" class="form-control" required placeholder="e.g., P001, DRESS001">
                                    <small style="color: var(--gray);">Only letters, numbers, and hyphens allowed</small>
                                </div>
                                <div class="form-group">
                                    <label for="productName">Product Name *</label>
                                    <input type="text" id="productName" class="form-control" required placeholder="e.g., Classic White T-Shirt">
                                </div>
                            </div>
                            
                            <div class="grid-2">
                                <div class="form-group">
                                    <label for="productCategory">Category *</label>
                                    <select id="productCategory" class="form-control" required>
                                        <option value="">Select Category</option>
                                        <option value="Tops">Tops</option>
                                        <option value="Bottoms">Bottoms</option>
                                        <option value="Dresses">Dresses</option>
                                        <option value="Outerwear">Outerwear</option>
                                        <option value="Accessories">Accessories</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="productSize">Size</label>
                                    <select id="productSize" class="form-control">
                                        <option value="">Select Size</option>
                                        <option value="XS">XS</option>
                                        <option value="S">S</option>
                                        <option value="M">M</option>
                                        <option value="L">L</option>
                                        <option value="XL">XL</option>
                                        <option value="28">28</option>
                                        <option value="30">30</option>
                                        <option value="32">32</option>
                                        <option value="34">34</option>
                                        <option value="36">36</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid-2">
                                <div class="form-group">
                                    <label for="productColor">Color</label>
                                    <input type="text" id="productColor" class="form-control" placeholder="e.g., White, Black, Red">
                                </div>
                                <div class="form-group">
                                    <label for="productPrice">Price (â‚±) *</label>
                                    <input type="number" id="productPrice" class="form-control" step="0.01" required placeholder="0.00">
                                </div>
                            </div>
                            
                            <div class="grid-2">
                                <div class="form-group">
                                    <label for="productStock">Initial Stock Quantity *</label>
                                    <input type="number" id="productStock" class="form-control" required placeholder="0" value="0">
                                </div>
                            </div>
                            
                            <button type="button" class="btn" onclick="addProduct()">
                                <i class="fas fa-plus"></i> Add Product to Inventory
                            </button>
                        </form>

                        <div class="card" style="margin-top: 2rem;">
                            <div class="card-header">
                                <h4>Quick Actions</h4>
                            </div>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="testFirebase()" class="btn btn-warning">
                                    <i class="fas fa-bolt"></i> Test Firebase
                                </button>
                                <button onclick="addSampleProducts()" class="btn btn-info">
                                    <i class="fas fa-vial"></i> Add Sample Products
                                </button>
                                <button onclick="loadProducts()" class="btn btn-success">
                                    <i class="fas fa-sync"></i> Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- QR Code Generator Tab -->
                    <div id="qr-generator-tab" class="tab-content">
                        <div class="inventory-grid">
                            <!-- Left: Product Selection & Form -->
                            <div>
                                <div class="card-header">
                                    <h3>Generate Product QR Codes</h3>
                                </div>
                                
                                <div class="form-group">
                                    <label for="qrProductSelect">Select Product</label>
                                    <select id="qrProductSelect" class="form-control" onchange="loadProductForQR()">
                                        <option value="">Select a product...</option>
                                    </select>
                                </div>
                                
                                <div class="grid-2">
                                    <div class="form-group">
                                        <label for="qrProductId">Product ID / Barcode *</label>
                                        <input type="text" id="qrProductId" class="form-control" required placeholder="e.g., P001, DRESS001">
                                    </div>
                                    <div class="form-group">
                                        <label for="qrProductName">Product Name *</label>
                                        <input type="text" id="qrProductName" class="form-control" required placeholder="e.g., Classic White T-Shirt">
                                    </div>
                                </div>
                                
                                <div class="grid-2">
                                    <div class="form-group">
                                        <label for="qrCategory">Category *</label>
                                        <select id="qrCategory" class="form-control" required>
                                            <option value="">Select Category</option>
                                            <option value="Tops">Tops</option>
                                            <option value="Bottoms">Bottoms</option>
                                            <option value="Dresses">Dresses</option>
                                            <option value="Outerwear">Outerwear</option>
                                            <option value="Accessories">Accessories</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="qrSize">Size</label>
                                        <select id="qrSize" class="form-control">
                                            <option value="">Select Size</option>
                                            <option value="XS">XS</option>
                                            <option value="S">S</option>
                                            <option value="M">M</option>
                                            <option value="L">L</option>
                                            <option value="XL">XL</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="grid-2">
                                    <div class="form-group">
                                        <label for="qrColor">Color</label>
                                        <input type="text" id="qrColor" class="form-control" placeholder="e.g., White, Black, Red">
                                    </div>
                                    <div class="form-group">
                                        <label for="qrPrice">Price (â‚±)</label>
                                        <input type="number" id="qrPrice" class="form-control" step="0.01" placeholder="0.00">
                                    </div>
                                </div>
                                
                                <button class="btn" onclick="generateQRCode()" style="margin-bottom: 1rem;">
                                    <i class="fas fa-qrcode"></i> Generate QR Code
                                </button>
                                
                                <!-- Batch Controls -->
                                <div class="card" style="margin-top: 2rem;">
                                    <div class="card-header">
                                        <h4>Batch QR Generation</h4>
                                    </div>
                                    <div class="grid-2">
                                        <div class="form-group">
                                            <label for="batchCount">Number of QR codes</label>
                                            <input type="number" id="batchCount" class="form-control" placeholder="Number of QR codes" min="1" max="50" value="1">
                                        </div>
                                        <div class="form-group" style="display: flex; align-items: flex-end;">
                                            <button class="btn btn-success" onclick="generateBatchQR()" style="width: 100%;">Generate Batch</button>
                                        </div>
                                    </div>
                                    <div class="batch-preview" id="batchPreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem; max-height: 400px; overflow-y: auto;"></div>
                                </div>
                            </div>
                            
                            <!-- Right: QR Preview -->
                            <div>
                                <div class="card-header">
                                    <h3>QR Code Preview</h3>
                                </div>
                                <div class="qr-container">
                                    <div id="qrcode"></div>
                                    <p style="color: var(--gray); margin-top: 1rem; font-size: 0.9rem;">
                                        Scan this QR code with your POS system to quickly add products
                                    </p>
                                </div>
                                
                                <div class="card" style="margin-top: 1rem;">
                                    <div class="card-header">
                                        <h4>Product Details</h4>
                                    </div>
                                    <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-light);">
                                        <span class="info-label" style="font-weight: 600; color: var(--gray);">Product ID:</span>
                                        <span class="info-value" id="previewId" style="color: var(--dark);">-</span>
                                    </div>
                                    <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-light);">
                                        <span class="info-label" style="font-weight: 600; color: var(--gray);">Name:</span>
                                        <span class="info-value" id="previewName" style="color: var(--dark);">-</span>
                                    </div>
                                    <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-light);">
                                        <span class="info-label" style="font-weight: 600; color: var(--gray);">Category:</span>
                                        <span class="info-value" id="previewCategory" style="color: var(--dark);">-</span>
                                    </div>
                                    <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-light);">
                                        <span class="info-label" style="font-weight: 600; color: var(--gray);">Size:</span>
                                        <span class="info-value" id="previewSize" style="color: var(--dark);">-</span>
                                    </div>
                                    <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-light);">
                                        <span class="info-label" style="font-weight: 600; color: var(--gray);">Color:</span>
                                        <span class="info-value" id="previewColor" style="color: var(--dark);">-</span>
                                    </div>
                                    <div class="info-row" style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid var(--gray-light);">
                                        <span class="info-label" style="font-weight: 600; color: var(--gray);">Price:</span>
                                        <span class="info-value" id="previewPrice" style="color: var(--dark);">-</span>
                                    </div>
                                </div>
                                
                                <button class="btn btn-success" onclick="printQRCode()" style="width: 100%; margin-top: 1rem;">
                                    <i class="fas fa-print"></i> Print QR Code
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-chart-line"></i> Sales Reports</h2>
                    </div>
                    <div id="reports-content">
                        <p>Sales reports and analytics will be displayed here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Modal -->
    <div id="printModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Print QR Code</h3>
                <button class="close-modal" onclick="closePrintModal()">&times;</button>
            </div>
            <div id="print-content"></div>
            <button class="btn" onclick="window.print()" style="width: 100%; margin-top: 1rem;">
                <i class="fas fa-print"></i> Print
            </button>
        </div>
    </div>

    <script>
    // === SECURITY CONFIGURATION ===
    const SECURITY_CONFIG = {
        sessionTimeout: 30 * 60 * 1000, // 30 minutes
        inactivityTimeout: 10 * 60 * 1000, // 10 minutes
        maxFileSize: 5 * 1024 * 1024 // 5MB
    };

    let sessionTimer;
    let inactivityTimer;
    let html5QrcodeScanner = null;

    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyDmKoIpaYbZDGVifyyZs0o75zJQcuRjqyc",
        authDomain: "boutique-f7274.firebaseapp.com",
        projectId: "boutique-f7274",
        storageBucket: "boutique-f7274.firebasestorage.app",
        messagingSenderId: "244540869684",
        appId: "1:244540869684:web:bb5f79a0af67c5e31f0e61"
    };

    // Initialize Firebase
    try {
        firebase.initializeApp(firebaseConfig);
        console.log('âœ… Firebase initialized successfully');
    } catch (error) {
        console.log('âœ… Firebase already initialized');
    }

    const db = firebase.firestore();

    // GLOBAL VARIABLES
    let allProducts = [];
    let cart = [];
    let salesChart = null;
    let inventoryChart = null;

    // === WORKING QR SCANNER FUNCTIONS ===

    function openQRScanner() {
        const scannerHTML = `
            <div id="qrScannerModal" class="modal" style="display: flex;">
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-camera"></i> QR Code Scanner</h3>
                        <button class="close-modal" onclick="closeQRScanner()">&times;</button>
                    </div>
                    <div style="text-align: center; padding: 1rem;">
                        <div id="qr-reader" style="width: 100%;"></div>
                        <div id="qr-reader-results" style="margin-top: 1rem;"></div>
                        <div class="scanner-controls">
                            <button onclick="closeQRScanner()" class="btn btn-danger">
                                <i class="fas fa-times"></i> Close Scanner
                            </button>
                            <button onclick="retryQRScan()" class="btn btn-warning">
                                <i class="fas fa-redo"></i> Retry Scan
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing scanner if any
        const existingScanner = document.getElementById('qrScannerModal');
        if (existingScanner) {
            existingScanner.remove();
        }
        
        document.body.insertAdjacentHTML('beforeend', scannerHTML);
        
        // Initialize QR Scanner
        initializeQRScanner();
    }

    function initializeQRScanner() {
        const qrReader = document.getElementById('qr-reader');
        qrReader.innerHTML = ''; // Clear previous scanner
        
        html5QrcodeScanner = new Html5QrcodeScanner(
            "qr-reader", 
            { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                supportedScanTypes: [
                    Html5QrcodeScanType.SCAN_TYPE_QR_CODE
                ]
            },
            false
        );
        
        html5QrcodeScanner.render(
            async (decodedText, decodedResult) => {
                console.log('QR Code scanned:', decodedText);
                await handleScannedQRCode(decodedText);
                
                // Stop scanner after successful scan
                if (html5QrcodeScanner) {
                    html5QrcodeScanner.clear();
                }
                
                // Close scanner modal after short delay
                setTimeout(() => {
                    closeQRScanner();
                }, 1000);
            }, 
            (error) => {
                console.log('QR Code scan error:', error);
            }
        );
    }

    function retryQRScan() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear();
        }
        initializeQRScanner();
    }

    function closeQRScanner() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear().then(() => {
                console.log("QR Scanner stopped.");
            }).catch(err => {
                console.log("Error stopping scanner:", err);
            });
        }
        
        const scannerModal = document.getElementById('qrScannerModal');
        if (scannerModal) {
            scannerModal.remove();
        }
    }

    // IMPROVED QR CODE HANDLING
    async function handleScannedQRCode(qrData) {
        try {
            console.log('Processing scanned QR data:', qrData);
            
            let productData;
            
            // Try to parse as JSON first
            try {
                productData = JSON.parse(qrData);
                console.log('QR parsed as JSON:', productData);
            } catch (e) {
                // If not JSON, treat as barcode directly
                console.log('QR is not JSON, treating as barcode');
                productData = { id: qrData };
            }
            
            const resultsDiv = document.getElementById('qr-reader-results');
            
            if (productData.id) {
                const product = await findProductByBarcode(productData.id);
                if (product) {
                    addToCart(product);
                    resultsDiv.innerHTML = `
                        <div style="background: var(--success); color: white; padding: 10px; border-radius: 5px;">
                            <i class="fas fa-check"></i> Product found: ${product.name}
                        </div>
                    `;
                    showFloatingNotification(`âœ… ${product.name} added to cart!`, 'success');
                } else {
                    resultsDiv.innerHTML = `
                        <div style="background: var(--danger); color: white; padding: 10px; border-radius: 5px;">
                            <i class="fas fa-exclamation-triangle"></i> Product not found: ${productData.id}
                        </div>
                    `;
                    showFloatingNotification('âŒ Product not found in database', 'error');
                }
            } else {
                resultsDiv.innerHTML = `
                    <div style="background: var(--warning); color: black; padding: 10px; border-radius: 5px;">
                        <i class="fas fa-exclamation-triangle"></i> Invalid QR code format
                    </div>
                `;
                showFloatingNotification('âŒ Invalid QR code format', 'error');
            }
            
        } catch (error) {
            console.error('Error handling scanned QR:', error);
            const resultsDiv = document.getElementById('qr-reader-results');
            resultsDiv.innerHTML = `
                <div style="background: var(--danger); color: white; padding: 10px; border-radius: 5px;">
                    <i class="fas fa-exclamation-triangle"></i> Error: ${error.message}
                </div>
            `;
            showFloatingNotification('âŒ Error scanning QR code', 'error');
        }
    }

    // IMPROVED QR CODE GENERATION
    function generateQRCode() {
        const productId = document.getElementById('qrProductId').value.trim();
        const productName = document.getElementById('qrProductName').value.trim();
        const category = document.getElementById('qrCategory').value;
        const size = document.getElementById('qrSize').value;
        const color = document.getElementById('qrColor').value.trim();
        const price = document.getElementById('qrPrice').value;

        if (!productId || !productName) {
            showFloatingNotification('Please enter Product ID and Name', 'error');
            return;
        }

        // Create product data for QR - SIMPLIFIED VERSION FOR BETTER COMPATIBILITY
        const productData = {
            id: productId,  // This is the most important field for scanning
            name: productName,
            category: category,
            size: size || '',
            color: color || '',
            price: price || '0'
        };

        const qrContainer = document.getElementById('qrcode');
        qrContainer.innerHTML = '';
        
        // Generate QR code with better options
        QRCode.toCanvas(qrContainer, JSON.stringify(productData), {
            width: 200,
            height: 200,
            margin: 2,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        }, function(error) {
            if (error) {
                console.error('QR Generation error:', error);
                showFloatingNotification('Error generating QR code: ' + error.message, 'error');
                return;
            }
            
            // Update preview information
            updateQRPreview(productData);
            
            showFloatingNotification('âœ… QR Code generated successfully!', 'success');
        });
    }

    function updateQRPreview(productData) {
        document.getElementById('previewId').textContent = productData.id;
        document.getElementById('previewName').textContent = productData.name;
        document.getElementById('previewCategory').textContent = productData.category || '-';
        document.getElementById('previewSize').textContent = productData.size || '-';
        document.getElementById('previewColor').textContent = productData.color || '-';
        document.getElementById('previewPrice').textContent = productData.price ? 'â‚±' + parseFloat(productData.price).toFixed(2) : '-';
    }

    // === SECURITY FUNCTIONS ===
    function initializeSecurity() {
        startSessionTimer();
        startInactivityTimer();
        validateSession();
        setupSecurityMonitoring();
        updateSecurityStatus();
    }

    function startSessionTimer() {
        clearTimeout(sessionTimer);
        sessionTimer = setTimeout(() => {
            logSecurityEvent('SESSION_TIMEOUT', { reason: 'session_timeout' });
            showFloatingNotification('Session expired due to timeout', 'warning');
            logout();
        }, SECURITY_CONFIG.sessionTimeout);
    }

    function startInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(() => {
            logSecurityEvent('SESSION_TIMEOUT', { reason: 'inactivity' });
            showFloatingNotification('Session expired due to inactivity', 'warning');
            logout();
        }, SECURITY_CONFIG.inactivityTimeout);
    }

    function resetInactivityTimer() {
        startInactivityTimer();
    }

    // Monitor user activity
    document.addEventListener('click', resetInactivityTimer);
    document.addEventListener('keypress', resetInactivityTimer);
    document.addEventListener('mousemove', resetInactivityTimer);

    function validateSession() {
        const userData = localStorage.getItem('user');
        const loginTime = localStorage.getItem('loginTime');
        
        if (!userData || !loginTime) {
            logout();
            return;
        }
        
        const sessionAge = Date.now() - parseInt(loginTime);
        if (sessionAge > SECURITY_CONFIG.sessionTimeout) {
            logout();
            return;
        }
        
        // Validate session structure
        try {
            const user = JSON.parse(userData);
            if (!user.sessionId || !user.role) {
                throw new Error('Invalid session data');
            }
        } catch (error) {
            console.error('Session validation failed:', error);
            logout();
        }
    }

    function updateSecurityStatus() {
        const statusElement = document.getElementById('securityStatus');
        if (statusElement) {
            statusElement.innerHTML = '<i class="fas fa-shield-alt"></i> Secure';
            statusElement.style.background = '#28a745';
        }
    }

    // Enhanced input validation
    function sanitizeInput(input) {
        if (typeof input !== 'string') return '';
        return input.replace(/[<>&"']/g, '');
    }

    function validateBarcode(barcode) {
        return /^[A-Z0-9-]{1,20}$/.test(barcode);
    }

    function validatePrice(price) {
        const num = parseFloat(price);
        return !isNaN(num) && num >= 0 && num <= 100000;
    }

    function validateStock(stock) {
        const num = parseInt(stock);
        return !isNaN(num) && num >= 0 && num <= 10000;
    }

    function setupSecurityMonitoring() {
        // Monitor for suspicious activities
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            console.log('ðŸ”’ Network request monitored:', args[0]);
            return originalFetch.apply(this, args);
        };
    }

    function logSecurityEvent(event, details) {
        const user = getCurrentUser();
        const logEntry = {
            event: event,
            details: details,
            user: user.username,
            role: user.role,
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            url: window.location.href
        };

        console.log('ðŸ”’ Security Event:', logEntry);

        // Store in localStorage for demo purposes
        const logs = JSON.parse(localStorage.getItem('securityLogs') || '[]');
        logs.push(logEntry);
        localStorage.setItem('securityLogs', JSON.stringify(logs.slice(-200)));

        // Send to Firebase
        try {
            db.collection('security_logs').add({
                ...logEntry,
                server_timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (error) {
            console.error('Failed to log security event:', error);
        }
    }

    function getCurrentUser() {
        try {
            return JSON.parse(localStorage.getItem('user')) || { username: 'unknown', role: 'guest' };
        } catch (error) {
            return { username: 'unknown', role: 'guest' };
        }
    }

    // Enhanced logout with security cleanup
    function logout() {
        logSecurityEvent('USER_LOGOUT', {
            reason: 'user_initiated'
        });
        
        clearTimeout(sessionTimer);
        clearTimeout(inactivityTimer);
        
        localStorage.removeItem('user');
        localStorage.removeItem('loginTime');
        sessionStorage.clear();
        
        window.location.href = 'index.html';
    }

    // Role-based access control
    function checkPermissions() {
        const user = getCurrentUser();
        document.getElementById('userRole').textContent = user.role.toUpperCase();
        
        if (user.role === 'cashier') {
            const sensitiveSections = [
                document.querySelector('[onclick="showSection(\'reports\')"]'),
                document.querySelector('[onclick="showSection(\'inventory\')"]')
            ];
            
            sensitiveSections.forEach(section => {
                if (section) section.style.display = 'none';
            });
        }
    }

    // === APPLICATION INITIALIZATION ===
    document.addEventListener('DOMContentLoaded', function() {
        checkLogin();
        initializeSecurity();
        checkPermissions();
        initializeApp();
    });

    function checkLogin() {
        const userData = localStorage.getItem('user');
        if (!userData) {
            window.location.href = 'index.html';
            return;
        }
        
        try {
            const user = JSON.parse(userData);
            document.getElementById('username-display').textContent = user.fullName || user.username;
            validateSession();
        } catch (error) {
            console.error('Invalid user data:', error);
            logout();
        }
    }

    async function initializeApp() {
        console.log('ðŸš€ Initializing secure dashboard...');
        updateLoadingText('Loading products...');
        
        try {
            await loadProducts();
            setupRealTimeListeners();
            initializeCharts();
            
            console.log('âœ… Secure dashboard ready!');
            updateLoadingText('Dashboard ready!');
            
            setTimeout(hideLoadingScreen, 1000);
            
        } catch (error) {
            console.error('âŒ Dashboard initialization failed:', error);
            updateLoadingText('Loading failed - showing demo data');
            hideLoadingScreen();
        }
    }

    // Loading screen functions
    function hideLoadingScreen() {
        const loadingScreen = document.getElementById('loadingScreen');
        if (loadingScreen) {
            loadingScreen.style.display = 'none';
        }
    }

    function updateLoadingText(text) {
        const loadingText = document.getElementById('loadingText');
        if (loadingText) {
            loadingText.textContent = text;
        }
    }

    // FLOATING NOTIFICATION FUNCTION
    function showFloatingNotification(message, type = 'success') {
        const existingNotifications = document.querySelectorAll('.floating-notification');
        existingNotifications.forEach(notif => notif.remove());
        
        const notification = document.createElement('div');
        notification.className = `floating-notification ${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}"></i>
            <span>${message}</span>
            <button class="notification-close" onclick="this.parentElement.remove()">
                <i class="fas fa-times"></i>
            </button>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    // REAL-TIME LISTENERS
    function setupRealTimeListeners() {
        console.log('ðŸ”” Setting up real-time listeners...');
        
        // Real-time listener for PRODUCTS
        db.collection('products')
            .onSnapshot((snapshot) => {
                console.log('ðŸ”„ Products updated -', snapshot.size, 'products');
                allProducts = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                displayProducts(allProducts);
                populateQRProductSelect(allProducts);
                updateDashboardStats();
                updateCharts();
                updateTopProducts();
                
            }, (error) => {
                console.error('âŒ Products listener error:', error);
            });

        // Real-time listener for SALES - FIXED
        db.collection('sales')
            .orderBy('created_at', 'desc')
            .onSnapshot((snapshot) => {
                console.log('ðŸ’° Sales updated -', snapshot.size, 'sales');
                updateDashboardStats();
                updateRecentActivity(snapshot);
                updateCharts();
                updateTopProducts();
                
            }, (error) => {
                console.error('âŒ Sales listener error:', error);
            });
    }

    // Load products function
    async function loadProducts() {
        try {
            console.log('ðŸ“¦ Loading products...');
            const snapshot = await db.collection('products')
                .orderBy('name')
                .get();
            
            allProducts = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            
            console.log(`âœ… Loaded ${allProducts.length} products`);
            displayProducts(allProducts);
            populateQRProductSelect(allProducts);
            updateDashboardStats();
            updateTopProducts();
            
        } catch (error) {
            console.error('âŒ Error loading products:', error);
            showFloatingNotification('Error loading products: ' + error.message, 'error');
        }
    }

    // ENHANCED Display products with categories and stock status
    function displayProducts(products) {
        const container = document.getElementById('products-list');
        if (!products || products.length === 0) {
            container.innerHTML = '<p>No products found. Add some products to get started!</p>';
            return;
        }

        // Group products by category
        const productsByCategory = {};
        products.forEach(product => {
            const category = product.category || 'Uncategorized';
            if (!productsByCategory[category]) {
                productsByCategory[category] = [];
            }
            productsByCategory[category].push(product);
        });

        let html = '';
        
        // Create tabs for each category
        html += `<div class="category-tabs" style="margin-bottom: 1rem;">`;
        Object.keys(productsByCategory).forEach((category, index) => {
            html += `
                <button class="tab-button ${index === 0 ? 'active' : ''}" 
                        onclick="showCategory('${category}')">
                    ${category} (${productsByCategory[category].length})
                </button>
            `;
        });
        html += `</div>`;

        // Create content for each category
        Object.keys(productsByCategory).forEach((category, index) => {
            html += `
                <div id="category-${category}" class="category-content" style="display: ${index === 0 ? 'block' : 'none'}">
                    <h3 style="margin-bottom: 1rem; color: #667eea;">${category}</h3>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Barcode</th>
                                <th>Name</th>
                                <th>Size</th>
                                <th>Color</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            productsByCategory[category].forEach(product => {
                const stockQuantity = product.stock_quantity || 0;
                
                let stockStatus = '';
                let statusClass = '';
                if (stockQuantity === 0) {
                    stockStatus = '<span class="out-of-stock">Out of Stock</span>';
                    statusClass = 'out-of-stock';
                } else if (stockQuantity <= (product.min_stock || 5)) {
                    stockStatus = '<span class="stock-low">Low Stock</span>';
                    statusClass = 'stock-low';
                } else {
                    stockStatus = '<span class="stock-ok">In Stock</span>';
                    statusClass = 'stock-ok';
                }
                
                html += `
                    <tr class="${statusClass}">
                        <td>${product.barcode}</td>
                        <td>${product.name}</td>
                        <td>${product.size || '-'}</td>
                        <td>${product.color || '-'}</td>
                        <td>â‚±${parseFloat(product.price || 0).toFixed(2)}</td>
                        <td>${stockQuantity}</td>
                        <td>${stockStatus}</td>
                        <td>
                            <button onclick="generateQRForProduct('${product.id}')" class="btn btn-success" style="padding: 5px 10px; font-size: 0.8rem;">
                                <i class="fas fa-qrcode"></i> QR
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
        });

        container.innerHTML = html;
    }

    // Show category function
    function showCategory(category) {
        // Hide all category contents
        document.querySelectorAll('.category-content').forEach(content => {
            content.style.display = 'none';
        });
        
        // Remove active class from all tabs
        document.querySelectorAll('.category-tabs .tab-button').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Show selected category and activate tab
        document.getElementById(`category-${category}`).style.display = 'block';
        event.target.classList.add('active');
    }

    // DASHBOARD STATS - FIXED
    async function updateDashboardStats() {
        try {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // Create Firestore timestamps correctly
            const todayStart = firebase.firestore.Timestamp.fromDate(today);
            const todayEnd = firebase.firestore.Timestamp.fromDate(tomorrow);

            const salesSnapshot = await db.collection('sales')
                .where('created_at', '>=', todayStart)
                .where('created_at', '<', todayEnd)
                .get();

            let todaySales = 0;
            let transactionCount = 0;
            
            salesSnapshot.forEach(doc => {
                const sale = doc.data();
                todaySales += sale.total_amount || 0;
                transactionCount++;
            });

            const totalProducts = allProducts.filter(p => (p.stock_quantity || 0) > 0).length;
            const lowStockItems = allProducts.filter(p => {
                const stock = p.stock_quantity || 0;
                return stock > 0 && stock <= 5;
            }).length;

            document.getElementById('today-sales').textContent = 'â‚±' + todaySales.toFixed(2);
            document.getElementById('total-products').textContent = totalProducts;
            document.getElementById('low-stock').textContent = lowStockItems;
            document.getElementById('today-transactions').textContent = transactionCount;
            
        } catch (error) {
            console.error('Error updating dashboard stats:', error);
        }
    }

    // CHARTS INITIALIZATION
    function initializeCharts() {
        const salesCtx = document.getElementById('salesChart').getContext('2d');
        salesChart = new Chart(salesCtx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Sales (â‚±)',
                    data: [12000, 19000, 15000, 25000, 22000, 30000, 28000],
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Weekly Sales Performance'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });

        updateCharts();
    }

    function updateCharts() {
        if (!inventoryChart) {
            const inventoryCtx = document.getElementById('inventoryChart').getContext('2d');
            inventoryChart = new Chart(inventoryCtx, {
                type: 'doughnut',
                data: {
                    labels: ['In Stock', 'Low Stock', 'Out of Stock'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#4CAF50', '#FF9800', '#F44336'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        const inStock = allProducts.filter(p => (p.stock_quantity || 0) > 10).length;
        const lowStock = allProducts.filter(p => {
            const stock = p.stock_quantity || 0;
            return stock > 0 && stock <= 10;
        }).length;
        const outOfStock = allProducts.filter(p => (p.stock_quantity || 0) === 0).length;

        inventoryChart.data.datasets[0].data = [inStock, lowStock, outOfStock];
        inventoryChart.update();
    }

    // UPDATE TOP PRODUCTS
    async function updateTopProducts() {
        try {
            const salesSnapshot = await db.collection('sales').get();
            const productSales = {};
            
            salesSnapshot.docs.forEach(doc => {
                const sale = doc.data();
                if (sale.items) {
                    sale.items.forEach(item => {
                        if (!productSales[item.product_name]) {
                            productSales[item.product_name] = 0;
                        }
                        productSales[item.product_name] += item.quantity;
                    });
                }
            });
            
            const topProductsContainer = document.getElementById('top-products');
            const sortedProducts = Object.entries(productSales)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            if (sortedProducts.length === 0) {
                topProductsContainer.innerHTML = `
                    <div class="cart-item">
                        <div>
                            <strong>No sales data yet</strong><br>
                            <small>Start selling to see top products</small>
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            sortedProducts.forEach(([productName, quantity], index) => {
                html += `
                    <div class="cart-item">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span style="background: #667eea; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">
                                ${index + 1}
                            </span>
                            <div>
                                <strong>${productName}</strong><br>
                                <small>${quantity} units sold</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            topProductsContainer.innerHTML = html;
            
        } catch (error) {
            console.error('Error updating top products:', error);
        }
    }

    // UPDATE RECENT ACTIVITY
    function updateRecentActivity(salesSnapshot) {
        const activityContainer = document.getElementById('recent-activity');
        
        if (salesSnapshot.empty) {
            activityContainer.innerHTML = `
                <div class="cart-item">
                    <i class="fas fa-info-circle" style="color: #667eea;"></i>
                    <div style="flex: 1; margin-left: 1rem;">
                        <strong>No recent activity</strong><br>
                        <small>Sales will appear here</small>
                    </div>
                </div>
            `;
            return;
        }
        
        let html = '';
        const recentSales = salesSnapshot.docs.slice(0, 5);
        
        recentSales.forEach(doc => {
            const sale = doc.data();
            const time = sale.created_at ? 
                sale.created_at.toDate().toLocaleTimeString() : 'Just now';
            const date = sale.created_at ?
                sale.created_at.toDate().toLocaleDateString() : 'Today';
            
            html += `
                <div class="cart-item">
                    <div class="activity-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div style="flex: 1;">
                        <strong>Sale: ${sale.transaction_code || 'TXN' + doc.id.slice(-4)}</strong><br>
                        <small>â‚±${(sale.total_amount || 0).toFixed(2)} â€¢ ${date} ${time}</small>
                    </div>
                </div>
            `;
        });
        
        activityContainer.innerHTML = html;
    }

    // SECURE PRODUCT ADDITION
    async function addProduct() {
        const barcode = sanitizeInput(document.getElementById('productBarcode').value.trim());
        const name = sanitizeInput(document.getElementById('productName').value.trim());
        const category = document.getElementById('productCategory').value;
        const size = document.getElementById('productSize').value;
        const color = sanitizeInput(document.getElementById('productColor').value.trim());
        const price = parseFloat(document.getElementById('productPrice').value);
        const stock_quantity = parseInt(document.getElementById('productStock').value) || 0;

        // Input validation
        if (!barcode || !name || !category) {
            showFloatingNotification('âŒ Please fill in Barcode, Name, and Category', 'error');
            return;
        }

        if (!validateBarcode(barcode)) {
            showFloatingNotification('âŒ Invalid barcode format. Use only letters, numbers, and hyphens.', 'error');
            return;
        }

        if (!validatePrice(price)) {
            showFloatingNotification('âŒ Invalid price. Must be between 0 and 100,000.', 'error');
            return;
        }

        if (!validateStock(stock_quantity)) {
            showFloatingNotification('âŒ Invalid stock quantity. Must be between 0 and 10,000.', 'error');
            return;
        }

        const button = document.querySelector('#add-product-tab button');
        const originalText = button.innerHTML;
        button.innerHTML = '<div class="loading"></div> Adding...';
        button.disabled = true;

        try {
            console.log('ðŸ”„ Adding product:', { barcode, name });

            // Check if barcode exists
            const existing = await db.collection('products')
                .where('barcode', '==', barcode)
                .get();
            
            if (!existing.empty) {
                throw new Error('Barcode already exists');
            }

            const productData = {
                barcode,
                name,
                category,
                size: size || '',
                color: color || '',
                price: price || 0,
                stock_quantity: stock_quantity || 0,
                min_stock: 5,
                created_by: getCurrentUser().username,
                created_at: firebase.firestore.FieldValue.serverTimestamp(),
                last_updated: firebase.firestore.FieldValue.serverTimestamp()
            };

            await db.collection('products').add(productData);
            
            // Log security event
            logSecurityEvent('PRODUCT_ADDED', { 
                barcode: barcode,
                name: name 
            });
            
            showFloatingNotification('âœ… Product added successfully!', 'success');
            document.getElementById('add-product-form').reset();
            
        } catch (error) {
            console.error('âŒ Error adding product:', error);
            
            // Log security event
            logSecurityEvent('PRODUCT_ADD_FAILED', { 
                barcode: barcode,
                error: error.message 
            });
            
            showFloatingNotification('âŒ Error: ' + error.message, 'error');
        } finally {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }

    // POS Functions
    async function findProductByBarcode(barcode) {
        try {
            const snapshot = await db.collection('products')
                .where('barcode', '==', barcode)
                .get();
            
            if (!snapshot.empty) {
                const doc = snapshot.docs[0];
                return {
                    id: doc.id,
                    ...doc.data()
                };
            }
            return null;
        } catch (error) {
            console.error('Error finding product:', error);
            return null;
        }
    }

    function addToCart(product) {
        const existingItem = cart.find(item => item.id === product.id);
        
        if (existingItem) {
            const newQuantity = existingItem.quantity + 1;
            if (newQuantity > product.stock_quantity) {
                showFloatingNotification(`âŒ Not enough stock! Only ${product.stock_quantity} available`, 'error');
                return;
            }
            existingItem.quantity = newQuantity;
        } else {
            if (product.stock_quantity < 1) {
                showFloatingNotification('âŒ Product out of stock!', 'error');
                return;
            }
            cart.push({
                ...product,
                quantity: 1
            });
        }
        
        updateCartDisplay();
        showFloatingNotification(`âœ… ${product.name} added to cart!`, 'success');
    }

    function updateCartDisplay() {
        const cartContainer = document.getElementById('cart');
        const subtotalElement = document.getElementById('subtotal');
        const totalElement = document.getElementById('total');
        
        if (cart.length === 0) {
            cartContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 3rem;">Cart is empty<br><small>Scan products to add them to cart</small></p>';
            subtotalElement.textContent = 'â‚±0.00';
            totalElement.textContent = 'â‚±0.00';
            return;
        }
        
        let html = '';
        let subtotal = 0;
        
        cart.forEach(item => {
            const itemTotal = item.price * item.quantity;
            subtotal += itemTotal;
            
            // Stock warning
            const stockStatus = item.quantity > item.stock_quantity ? 
                `<div class="stock-warning out-of-stock-warning">
                    <i class="fas fa-exclamation-triangle"></i> Not enough stock! 
                    (Available: ${item.stock_quantity})
                </div>` :
                (item.stock_quantity - item.quantity <= 5 ? 
                `<div class="stock-warning">
                    <i class="fas fa-info-circle"></i> Low stock after purchase 
                    (Will be: ${item.stock_quantity - item.quantity})
                </div>` : '');
            
            html += `
                <div class="cart-item">
                    <div style="flex: 1;">
                        <strong>${item.name}</strong><br>
                        <small>${item.barcode} â€¢ â‚±${item.price.toFixed(2)}</small>
                        ${stockStatus}
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button onclick="updateQuantity('${item.id}', -1)" class="btn btn-warning" style="padding: 5px 10px;">-</button>
                        <span style="font-weight: bold; min-width: 30px; text-align: center;">${item.quantity}</span>
                        <button onclick="updateQuantity('${item.id}', 1)" class="btn btn-success" style="padding: 5px 10px;">+</button>
                        <strong>â‚±${itemTotal.toFixed(2)}</strong>
                        <button onclick="removeFromCart('${item.id}')" class="btn btn-danger" style="padding: 5px 10px; margin-left: 10px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        const total = subtotal;
        
        cartContainer.innerHTML = html;
        subtotalElement.textContent = 'â‚±' + subtotal.toFixed(2);
        totalElement.textContent = 'â‚±' + total.toFixed(2);
    }

    function updateQuantity(productId, change) {
        const item = cart.find(item => item.id === productId);
        if (item) {
            const newQuantity = item.quantity + change;
            
            if (newQuantity < 1) {
                removeFromCart(productId);
                return;
            }
            
            // Check stock availability
            const product = allProducts.find(p => p.id === productId);
            if (product && newQuantity > product.stock_quantity) {
                showFloatingNotification(`âŒ Cannot add more! Only ${product.stock_quantity} available`, 'error');
                return;
            }
            
            item.quantity = newQuantity;
            updateCartDisplay();
        }
    }

    function removeFromCart(productId) {
        const item = cart.find(item => item.id === productId);
        if (item) {
            showFloatingNotification(`ðŸ—‘ï¸ ${item.name} removed from cart`, 'warning');
        }
        cart = cart.filter(item => item.id !== productId);
        updateCartDisplay();
    }

    function clearCart() {
        if (cart.length > 0) {
            showFloatingNotification('ðŸ—‘ï¸ Cart cleared', 'warning');
        }
        cart = [];
        updateCartDisplay();
    }

    // SECURE PAYMENT PROCESSING WITH QR RECEIPT
    async function processPayment() {
        if (cart.length === 0) {
            showFloatingNotification('âŒ Cart is empty!', 'error');
            return;
        }

        // Validate all items before processing
        for (const item of cart) {
            const product = allProducts.find(p => p.id === item.id);
            if (!product) {
                showFloatingNotification(`âŒ Product ${item.name} not found!`, 'error');
                return;
            }
            if (item.quantity > product.stock_quantity) {
                showFloatingNotification(`âŒ Not enough stock for ${item.name}! Available: ${product.stock_quantity}`, 'error');
                return;
            }
        }

        const button = document.querySelector('#pos button');
        const originalText = button.innerHTML;
        button.innerHTML = '<div class="loading"></div> Processing...';
        button.disabled = true;

        try {
            // Calculate totals
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const total = subtotal;
            const paymentMethod = document.getElementById('payment-method').value;

            // Validate payment data
            if (total <= 0) {
                throw new Error('Invalid total amount');
            }

            // Generate transaction code
            const transactionCode = 'TXN' + Date.now() + Math.random().toString(36).substr(2, 5).toUpperCase();

            // Create sale record with security context
            const saleData = {
                transaction_code: transactionCode,
                total_amount: total,
                subtotal_amount: subtotal,
                payment_method: paymentMethod,
                cashier_id: getCurrentUser().username,
                cashier_role: getCurrentUser().role,
                created_at: firebase.firestore.FieldValue.serverTimestamp(),
                items: cart.map(item => ({
                    product_id: item.id,
                    product_name: item.name,
                    barcode: item.barcode,
                    quantity: item.quantity,
                    unit_price: item.price,
                    total_price: item.price * item.quantity
                })),
                security_context: {
                    user_agent: navigator.userAgent,
                    timestamp: new Date().toISOString()
                }
            };

            // Use batch write for atomic operations
            const batch = db.batch();
            
            // Add sale record
            const saleRef = db.collection('sales').doc();
            batch.set(saleRef, saleData);

            // Update product stock for each item
            cart.forEach(item => {
                const productRef = db.collection('products').doc(item.id);
                const newStock = item.stock_quantity - item.quantity;
                
                batch.update(productRef, {
                    stock_quantity: newStock,
                    last_updated: firebase.firestore.FieldValue.serverTimestamp(),
                    last_updated_by: getCurrentUser().username
                });
            });

            // Commit all operations
            await batch.commit();

            // Log security event
            logSecurityEvent('SALE_PROCESSED', {
                transaction_code: saleData.transaction_code,
                total_amount: total,
                items_count: cart.length
            });

            // Generate and show QR receipt
            generateQRReceipt(saleData);
            
            showFloatingNotification(`âœ… Payment successful! Transaction: ${saleData.transaction_code}`, 'success');
            
            // Clear cart
            clearCart();
            
            console.log('ðŸ’° Sale recorded:', saleData);
            
        } catch (error) {
            console.error('âŒ Error processing payment:', error);
            
            // Log security event
            logSecurityEvent('PAYMENT_FAILED', {
                error: error.message,
                cart_size: cart.length
            });
            
            showFloatingNotification('âŒ Payment failed: ' + error.message, 'error');
        } finally {
            button.innerHTML = originalText;
            button.disabled = false;
        }
    }

    // GENERATE QR RECEIPT
    function generateQRReceipt(saleData) {
        const receiptData = {
            transaction_code: saleData.transaction_code,
            date: new Date().toLocaleString(),
            total: saleData.total_amount,
            items: saleData.items.map(item => ({
                name: item.product_name,
                quantity: item.quantity,
                price: item.unit_price
            })),
            store: "Phelai's Boutique"
        };

        const receiptModalHTML = `
            <div id="receiptModal" class="modal" style="display: flex;">
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>Payment Successful! ðŸŽ‰</h3>
                        <button class="close-modal" onclick="closeReceiptModal()">&times;</button>
                    </div>
                    <div style="text-align: center; padding: 1rem;">
                        <h4>Digital Receipt</h4>
                        <div id="receiptQR" style="margin: 1rem auto; padding: 1rem; background: white; border-radius: 10px; display: inline-block;"></div>
                        <div style="text-align: left; margin-top: 1rem;">
                            <p><strong>Transaction:</strong> ${saleData.transaction_code}</p>
                            <p><strong>Date:</strong> ${new Date().toLocaleString()}</p>
                            <p><strong>Total:</strong> â‚±${saleData.total_amount.toFixed(2)}</p>
                            <p><strong>Items:</strong> ${saleData.items.length}</p>
                        </div>
                        <p style="font-size: 0.9rem; color: #666; margin-top: 1rem;">
                            Scan this QR code to view your receipt details
                        </p>
                        <button onclick="closeReceiptModal()" class="btn" style="margin-top: 1rem;">
                            <i class="fas fa-check"></i> Done
                        </button>
                        <button onclick="printReceipt()" class="btn btn-success" style="margin-top: 1rem; margin-left: 0.5rem;">
                            <i class="fas fa-print"></i> Print Receipt
                        </button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', receiptModalHTML);

        // Generate QR code for receipt
        QRCode.toCanvas(document.getElementById('receiptQR'), JSON.stringify(receiptData), {
            width: 200,
            height: 200,
            margin: 1
        }, function(error) {
            if (error) {
                console.error('QR receipt generation error:', error);
                document.getElementById('receiptQR').innerHTML = '<p>Error generating QR code</p>';
            }
        });
    }

    function closeReceiptModal() {
        const receiptModal = document.getElementById('receiptModal');
        if (receiptModal) {
            receiptModal.remove();
        }
    }

    function printReceipt() {
        window.print();
    }

    function generateQRForProduct(productId) {
        const product = allProducts.find(p => p.id === productId);
        if (product) {
            // Switch to QR Generator tab
            showTab('qr-generator-tab');
            
            // Fill the form with product data
            document.getElementById('qrProductId').value = product.barcode;
            document.getElementById('qrProductName').value = product.name;
            document.getElementById('qrCategory').value = product.category;
            document.getElementById('qrSize').value = product.size || '';
            document.getElementById('qrColor').value = product.color || '';
            document.getElementById('qrPrice').value = product.price || '';
            
            // Generate QR code
            generateQRCode();
        }
    }

    function populateQRProductSelect(products) {
        const select = document.getElementById('qrProductSelect');
        select.innerHTML = '<option value="">Select a product...</option>';
        
        products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = `${product.barcode} - ${product.name}`;
            option.setAttribute('data-product', JSON.stringify(product));
            select.appendChild(option);
        });
    }

    function loadProductForQR() {
        const select = document.getElementById('qrProductSelect');
        const selectedOption = select.options[select.selectedIndex];
        
        if (selectedOption.value) {
            const product = JSON.parse(selectedOption.getAttribute('data-product'));
            
            document.getElementById('qrProductId').value = product.barcode;
            document.getElementById('qrProductName').value = product.name;
            document.getElementById('qrCategory').value = product.category;
            document.getElementById('qrSize').value = product.size || '';
            document.getElementById('qrColor').value = product.color || '';
            document.getElementById('qrPrice').value = product.price || '';
            
            generateQRCode();
        }
    }

    // Utility Functions
    function showSection(sectionId) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        
        document.getElementById(sectionId).classList.add('active');
        event.target.classList.add('active');
        
        const titles = {
            'dashboard': 'Dashboard',
            'pos': 'POS System', 
            'inventory': 'Inventory',
            'reports': 'Reports'
        };
        document.getElementById('page-title').textContent = titles[sectionId] || 'Dashboard';
        
        if (sectionId === 'dashboard') {
            updateDashboardStats();
        }
    }

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
    }

    // Test Functions
    async function testFirebase() {
        try {
            await db.collection('test').doc('connection').set({
                test: true,
                timestamp: new Date()
            });
            showFloatingNotification('âœ… Firebase connection working!', 'success');
        } catch (error) {
            showFloatingNotification('âŒ Firebase error: ' + error.message, 'error');
        }
    }

    async function addSampleProducts() {
        const sampleProducts = [
            {
                barcode: 'TS001',
                name: 'Classic White T-Shirt',
                category: 'Tops',
                size: 'M',
                color: 'White',
                price: 299.00,
                stock_quantity: 50,
                min_stock: 5
            },
            {
                barcode: 'DR001',
                name: 'Summer Floral Dress',
                category: 'Dresses',
                size: 'L',
                color: 'Floral',
                price: 899.00,
                stock_quantity: 25,
                min_stock: 5
            },
            {
                barcode: 'JN001',
                name: 'Slim Fit Jeans',
                category: 'Bottoms',
                size: '32',
                color: 'Blue',
                price: 799.00,
                stock_quantity: 30,
                min_stock: 5
            }
        ];

        try {
            for (const product of sampleProducts) {
                await db.collection('products').add({
                    ...product,
                    created_at: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            showFloatingNotification('âœ… Sample products added successfully!', 'success');
        } catch (error) {
            showFloatingNotification('âŒ Error adding sample products: ' + error.message, 'error');
        }
    }

    // Barcode scanner functionality
    document.getElementById('barcodeInput').addEventListener('input', async function(e) {
        const barcode = e.target.value.trim();
        
        if (barcode.length > 3) {
            const product = await findProductByBarcode(barcode);
            if (product) {
                addToCart(product);
                e.target.value = '';
                document.getElementById('product-search-results').style.display = 'none';
            } else {
                // Show search results
                const searchResults = allProducts.filter(p => 
                    p.barcode.includes(barcode) || 
                    p.name.toLowerCase().includes(barcode.toLowerCase())
                );
                
                showSearchResults(searchResults);
            }
        }
    });

    function showSearchResults(products) {
        const resultsContainer = document.getElementById('product-search-results');
        
        if (products.length === 0) {
            resultsContainer.style.display = 'none';
            return;
        }
        
        let html = '';
        products.forEach(product => {
            html += `
                <div class="cart-item" onclick="selectSearchProduct('${product.id}')" style="cursor: pointer;">
                    <div>
                        <strong>${product.name}</strong><br>
                        <small>${product.barcode} â€¢ â‚±${product.price.toFixed(2)} â€¢ Stock: ${product.stock_quantity}</small>
                    </div>
                </div>
            `;
        });
        
        resultsContainer.innerHTML = html;
        resultsContainer.style.display = 'block';
    }

    function selectSearchProduct(productId) {
        const product = allProducts.find(p => p.id === productId);
        if (product) {
            addToCart(product);
            document.getElementById('barcodeInput').value = '';
            document.getElementById('product-search-results').style.display = 'none';
        }
    }

    // Print QR Code
    function printQRCode() {
        const qrContent = document.getElementById('qrcode').innerHTML;
        const printContent = document.getElementById('print-content');
        printContent.innerHTML = qrContent;
        document.getElementById('printModal').style.display = 'flex';
    }

    function closePrintModal() {
        document.getElementById('printModal').style.display = 'none';
    }

    // Batch QR Generation
    function generateBatchQR() {
        const count = parseInt(document.getElementById('batchCount').value) || 1;
        const batchPreview = document.getElementById('batchPreview');
        batchPreview.innerHTML = '';
        
        for (let i = 1; i <= count; i++) {
            const productId = `BATCH${i}`;
            const productName = `Batch Product ${i}`;
            
            const qrContainer = document.createElement('div');
            qrContainer.className = 'batch-qr';
            qrContainer.innerHTML = `<div class="product-id">${productId}</div>`;
            
            QRCode.toCanvas(qrContainer, JSON.stringify({
                id: productId,
                name: productName
            }), function(error) {
                if (error) console.error('Batch QR error:', error);
            });
            
            batchPreview.appendChild(qrContainer);
        }
        
        showFloatingNotification(`âœ… Generated ${count} batch QR codes!`, 'success');
    }
</script>
</body>
</html>
